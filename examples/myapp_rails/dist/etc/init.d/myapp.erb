#!/bin/sh
### BEGIN INIT INFO
# Provides:          <%=name%>
# Required-Start:    networking
# Required-Stop:     networking
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start the <%=name%> web application server.
### END INIT INFO

# httpd        Startup script for the <%=name%> web application server
#
# chkconfig: - 85 15
# description: <%=name%>
# processname: <%=name%>

# FIXME PATH to find mongrel_rails and pen

PEN_PID_FILE=/var/run/pen_for_<%=name%>.pid

case "$1" in
  start)
    su - <%=user%> "cd <%=path%>; mongrel_rails cluster::start -C config/mongrel_cluster.yml"
    pen <%=bind%> -H -r -p $PEN_PID_FILE <%=(1..backend).map{|i| "localhost:"+(i-1+port)}.join(" ")%>
    ;;
  stop)
    su - <%=user%> "cd <%=path%>; mongrel_rails cluster::stop -C config/mongrel_cluster.yml"
    kill `cat $PEN_PID_FILE`
    ;;
  restart)
    su - <%=user%> "cd <%=path%>; mongrel_rails cluster::restart -C config/mongrel_cluster.yml"
    # Leave pen alone for simplicity's sake
    ;;
  status)
    su - <%=user%> "cd <%=path%>; ! (mongrel_rails cluster::status -C config/mongrel_cluster.yml 2>&1 | ! grep -q missing)"
    # Leave pen alone for simplicity's sake
    ;;
  *)
    echo $"Usage: <%=name%> {start|stop|restart|status}"
    exit 1
esac
